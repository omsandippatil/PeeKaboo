<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeeKaboo?</title>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <script src="Config/config.js"></script>
    <script src="style.css"></script>
</head>

<body>
    <div class="container">
        <h1>PeeKaboo?</h1>
        <form id="searchForm">
            <input type="text" id="searchInput" name="q" placeholder="Enter your query..." required>
            <div id="suggestions" class="suggestions">
                <span class="question">What is today's breaking news?</span>
                <span class="question">Trends in computer science technology</span>
                <span class="question">Software Testing Methods</span>
                <span class="question">Why is interstellar the best movie?</span>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="showImagesCheckbox" class="custom-checkbox" checked>
                <span>Show Images</span>
            </div>
            <button type="submit">EXECUTE</button>
        </form>
        <div id="results"></div>
        <div class="images-container" id="imagesContainer"></div>
        <div id="summary"></div>
        <footer>&copy; 2024 PeeKaboo | Powered by Illuminati</footer>
    </div>

    <script>
        (function () {
            console.log("Script started");

            function logError(message, error) {
                console.error(message, error);
                document.getElementById('results').innerHTML += `<p style="color: red;">${message}: ${error.message}</p>`;
            }

            try {
                if (!CONFIG) {
                    throw new Error("CONFIG is not defined. Make sure config.js is loaded correctly.");
                }

                document.addEventListener("DOMContentLoaded", function () {
                    console.log("DOMContentLoaded event fired");

                    const searchInput = document.getElementById("searchInput");
                    const searchForm = document.getElementById("searchForm");
                    const resultsDiv = document.getElementById("results");
                    const imagesContainer = document.getElementById("imagesContainer");
                    const summaryDiv = document.getElementById("summary");
                    const showImagesCheckbox = document.getElementById("showImagesCheckbox");

                    document.querySelectorAll('.question').forEach(q => {
                        q.addEventListener('click', function () {
                            searchInput.value = this.textContent;
                        });
                    });

                    searchForm.addEventListener("submit", async function (e) {
                        e.preventDefault();
                        resultsDiv.innerHTML = 'Processing query...';
                        imagesContainer.innerHTML = '';
                        summaryDiv.innerHTML = '';

                        try {
                            const query = searchInput.value + " News";
                            const isOnline = await checkInternetConnection();
                            if (!isOnline) {
                                throw new Error('No internet connection');
                            }

                            const searchResults = await searchWithTavily(query);
                            let imageResults = [];
                            
                            if (showImagesCheckbox.checked) {
                                imageResults = await searchImagesWithGoogle(query);
                                displayImages(imageResults);
                            }

                            displayResults(searchResults);

                            const snippets = searchResults.map(result => ({
                                snippet: result.snippet,
                            }));
                            const promptContext = setupGetAnswerPrompt(snippets, imageResults);
                            const groqResponse = await requestGroq(query, promptContext);
                            const groqText = groqResponse.choices[0].message.content;
                            summaryDiv.innerHTML = `<h3>Summary:</h3><p>${groqText}</p>`;

                        } catch (error) {
                            logError("Search error", error);
                        }
                    });

                    function displayResults(results) {
                        resultsDiv.innerHTML = '<h3>News Results:</h3>';
                        results.forEach(result => {
                            const resultDiv = document.createElement('div');
                            resultDiv.className = 'news-result';
                            resultDiv.innerHTML = `
                                <h4><a href="${result.url}" target="_blank">${result.title}</a></h4>
                                <p>${result.snippet || result.content}</p>
                            `;
                            resultsDiv.appendChild(resultDiv);
                        });
                    }

                    function displayImages(images) {
                        imagesContainer.innerHTML = '<h3>Image Results:</h3>';
                        images.forEach(image => {
                            const imageDiv = document.createElement('div');
                            imageDiv.className = 'image-item';
                            imageDiv.innerHTML = `<img src="${image.link}" alt="News Image" onerror="this.onerror=null; this.src='placeholder.jpg';">`;
                            imagesContainer.appendChild(imageDiv);
                        });
                    }

                    // Your existing utility functions remain the same
                    async function checkInternetConnection() {
                        try {
                            await fetch('https://www.google.com', { mode: 'no-cors', cache: 'no-store' });
                            return true;
                        } catch {
                            return false;
                        }
                    }

                    async function searchWithTavily(query) {
                        try {
                            const response = await fetch('https://api.tavily.com/search', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    api_key: CONFIG.TAVILY_API_KEY,
                                    query: query,
                                    max_results: 10,
                                    search_depth: "news"
                                })
                            });

                            if (!response.ok) {
                                throw new Error(`Tavily AI request failed: ${response.status}`);
                            }

                            const data = await response.json();
                            if (!data.results || data.results.length === 0) {
                                throw new Error('No results returned from Tavily AI');
                            }
                            return data.results;
                        } catch (error) {
                            throw error;
                        }
                    }

                    async function searchImagesWithGoogle(query) {
                        try {
                            const response = await fetch(`https://www.googleapis.com/customsearch/v1?key=${CONFIG.GOOGLE_API_KEY}&cx=${CONFIG.GOOGLE_SEARCH_ENGINE_ID}&q=${query}&searchType=image&num=4`);

                            if (!response.ok) {
                                throw new Error(`Google Image Search error: ${response.status}`);
                            }

                            const data = await response.json();
                            return data.items || [];
                        } catch (error) {
                            throw error;
                        }
                    }

                    function setupGetAnswerPrompt(snippets, images) {
                        const startingContext = `Answer all this  1. A detailed, paragraphed, comprehensive answer to the question. It must be accurate, high-quality, and expertly written in a positive, interesting, and engaging manner. The answer should be informative and in the same language as the user question. Aim for at least 300 words in your response.  
                        2. After your main answer, provide a section titled "Image Descriptions" where you describe how each of the provided images relates to the topic. Use the format: "Image X: [Brief description and relevance to the topic]"`;

                        const snippetsText = snippets.map((s, i) => `[citation:${i + 1}] ${s.snippet}`).join('\n\n');
                        const imageContext = "\nHere are descriptions of relevant images:\n" + images.map((_, index) => `Image ${index + 1}: [Brief description and relevance to the topic]`).join('\n');
                        
                        return `${startingContext}\n\n${snippetsText}\n\n${imageContext}\n\nUse the provided information to create a comprehensive and engaging response.`;
                    }

                    async function requestGroq(query, context) {
                        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${CONFIG.GROQ_API_KEY}`,
                            },
                            body: JSON.stringify({
                                model: "mixtral-8x7b-32768",
                                messages: [
                                    { role: "system", content: context },
                                    { role: "user", content: query }
                                ],
                                temperature: 0.7,
                                max_tokens: 3000,
                            }),
                        });

                        return response.json();
                    }
                });
            } catch (error) {
                logError("Initialization error", error);
            }
        })();
    </script>
</body>
</html>
