<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeeKaboo?</title>
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <script src="Config/config.js"></script>
    <style>

    </style>
</head>

<body>
    <div class="container">
        <h1>PeeKaboo?</h1>
        <form id="searchForm">
            <input type="text" id="searchInput" name="q" placeholder="Enter your query..." required>
            <div id="suggestions" class="suggestions"></div>
            <label>
                <input type="checkbox" id="showImagesCheckbox" class="custom-checkbox" checked>
                <span>Show Images</span>
            </label>
            <button type="submit">EXECUTE</button>
        </form>
        <div id="results"></div>
        <div id="summary"></div>
        <footer>&copy; 2024 PeeKaboo | Powered by Illuminati</footer>
    </div>

    <script>
        (function () {
    console.log("Script started");

    function logError(message, error) {
        console.error(message, error);
        document.getElementById('results').innerHTML += `<p style="color: red;">${message}: ${error.message}</p>`;
    }

    try {
        if (!CONFIG) {
            throw new Error("CONFIG is not defined. Make sure config.js is loaded correctly.");
        }

        document.addEventListener("DOMContentLoaded", function () {
            console.log("DOMContentLoaded event fired");

            const searchInput = document.getElementById("searchInput");
            const suggestionsDiv = document.getElementById("suggestions");
            const searchForm = document.getElementById("searchForm");
            const resultsDiv = document.getElementById("results");
            const summaryDiv = document.getElementById("summary");
            const showImagesCheckbox = document.getElementById("showImagesCheckbox");

            const questions = [
                "What is today's breaking news?",
                "Trends in computer science technology",
                "Software Testing Methods",
                "Why is interstellar the best movie?"
            ];
            const suggestionsHtml = questions.map(q => `<span class="question">${q}</span>`).join('');
            suggestionsDiv.innerHTML = suggestionsHtml;

            document.querySelectorAll('.question').forEach(q => {
                q.addEventListener('click', function () {
                    searchInput.value = this.textContent;
                });
            });

            searchForm.addEventListener("submit", async function (e) {
                e.preventDefault();
                resultsDiv.innerHTML = 'Processing query...';
                summaryDiv.innerHTML = '';

                try {
                    const query = searchInput.value + " News"; // Append "News" to the query
                    const isOnline = await checkInternetConnection();
                    if (!isOnline) {
                        throw new Error('No internet connection');
                    }

                    console.log("Searching for news with Tavily...");
                    const searchResults = await searchWithTavily(query);
                    console.log("Tavily search results:", searchResults);

                    let imageResults = [];
                    if (showImagesCheckbox.checked) {
                        console.log("Searching for images...");
                        imageResults = await searchImagesWithGoogle(query);
                        console.log("Image search results:", imageResults);
                    }

                    displayResults(searchResults, imageResults, resultsDiv);

                    console.log("Summarizing with Groq...");
                    const snippets = searchResults.map(result => ({
                        snippet: result.snippet,
                    }));
                    const promptContext = setupGetAnswerPrompt(snippets, imageResults);
                    const groqResponse = await requestGroq(query, promptContext);
                    const groqText = groqResponse.choices[0].message.content;
                    summaryDiv.innerHTML = `<h3>Summary:</h3><p>${groqText}</p>`;

                } catch (error) {
                    logError("Search error", error);
                }
            });

            async function checkInternetConnection() {
                try {
                    await fetch('https://www.google.com', { mode: 'no-cors', cache: 'no-store' });
                    return true;
                } catch {
                    return false;
                }
            }

            async function searchWithTavily(query) {
                try {
                    const response = await fetch('https://api.tavily.com/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            api_key: CONFIG.TAVILY_API_KEY,
                            query: query,
                            max_results: 10,
                            search_depth: "news" // Setting the search topic to "news"
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Tavily AI request failed: ${response.status} ${response.statusText}. ${errorText}`);
                    }

                    const data = await response.json();
                    if (!data.results || data.results.length === 0) {
                        throw new Error('No results returned from Tavily AI');
                    }
                    return data.results;
                } catch (error) {
                    console.error('Tavily AI search error:', error);
                    throw error;
                }
            }

            async function searchImagesWithGoogle(query) {
                try {
                    const response = await fetch(`https://www.googleapis.com/customsearch/v1?key=${CONFIG.GOOGLE_API_KEY}&cx=${CONFIG.GOOGLE_SEARCH_ENGINE_ID}&q=${query}&searchType=image&num=4`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Google Image Search error: ${response.status} ${response.statusText}. ${errorText}`);
                    }

                    const data = await response.json();
                    if (!data.items || data.items.length === 0) {
                        return [];
                    }
                    return data.items;
                } catch (error) {
                    logError('Google Image search error', error);
                    throw error;
                }
            }

            function displayResults(textResults, imageResults, container) {
                container.innerHTML = '';

                // Display news results
                const textResultsDiv = document.createElement('div');
                textResultsDiv.innerHTML = '<h3>News Results:</h3>';
                textResults.forEach(result => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'news-result';
                    resultDiv.innerHTML = `<h4><a href="${result.url}" target="_blank">${result.title}</a></h4><p>${result.snippet || result.content}</p>`;
                    textResultsDiv.appendChild(resultDiv);
                });
                container.appendChild(textResultsDiv);

                // Display image results
                if (imageResults.length > 0 && showImagesCheckbox.checked) {
                    const imageResultsDiv = document.createElement('div');
                    imageResultsDiv.innerHTML = '<h3>Image Results:</h3>';
                    imageResultsDiv.style.whiteSpace = 'nowrap';
                    imageResultsDiv.style.overflowX = 'auto';
                    imageResultsDiv.style.display = 'flex';
                    imageResults.forEach(image => {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.display = 'inline-block';
                        imgDiv.style.height = '200px';
                        imgDiv.style.marginRight = '10px';
                        imgDiv.innerHTML = `<img src="${image.link}" alt="News Image" style="height: 100%; width: auto;" onerror="this.onerror=null; this.src='placeholder.jpg';">`;
                        imageResultsDiv.appendChild(imgDiv);
                    });
                    container.appendChild(imageResultsDiv);
                }
            }

            function getSnippetsForPrompt(snippets) {
                return snippets.map((s, i) => `[citation:${i + 1}] ${s.snippet}`).join('\n\n');
            }

            function setupGetAnswerPrompt(snippets, images) {
                const startingContext = `Answer all this  1. A detailed, paragraphed, comprehensive answer to the question. It must be accurate, high-quality, and expertly written in a positive, interesting, and engaging manner. The answer should be informative and in the same language as the user question. Aim for at least 300 words in your response.  
                2. After your main answer, provide a section titled "Image Descriptions" where you describe how each of the provided images relates to the topic. Use the format: "Image X: [Brief description and relevance to the topic]"  
                For all parts of your response, you will be provided with a set of citations to the question. Each will start with a reference number like [citation:x], where x is a number. Always use the related citations and cite the citation at the end of each sentence in the format [citation:x]. If a sentence comes from multiple citations, please list all applicable citations, like [citation:2][citation:3].  Here are the provided citations:`;

                const imageContext = "\nHere are descriptions of relevant images:\n" + images.map((_, index) => `Image ${index + 1}: [Brief description and relevance to the topic]`).join('\n');
                const finalContext = "Use the provided information to create a comprehensive and engaging response.";

                return `${startingContext}\n\n${getSnippetsForPrompt(snippets)}\n\n${imageContext}\n\n${finalContext}`;
            }

            function requestGroq(query, context, maxTokens = 3000, model = "mixtral-8x7b-32768", temperature = 0.7) {
                const GROQ_ENDPOINT = "https://api.groq.com/openai/v1/chat/completions";

                const requestBody = {
                    model: model,
                    messages: [
                        { role: "system", content: context },
                        { role: "user", content: query }
                    ],
                    temperature: temperature,
                    max_tokens: maxTokens,
                };

                return fetch(GROQ_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.GROQ_API_KEY}`,
                    },
                    body: JSON.stringify(requestBody),
                })
                .then(response => response.json());
            }
        });
    } catch (error) {
        logError("Initialization error", error);
    }
})();
    </script>
</body>

</html>
